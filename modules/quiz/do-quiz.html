<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Làm bài thi - EduPlatform</title>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <style>
        .quiz-container { max-width: 800px; margin: 0 auto; }
        .question-card { background: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .question-text { font-weight: bold; font-size: 1.1rem; margin-bottom: 20px; color: #1e293b; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; }
        
        /* Style cho đáp án đẹp hơn */
        .option-label { 
            display: flex; 
            align-items: center; 
            padding: 12px 15px; 
            border: 2px solid #e2e8f0; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            cursor: pointer; 
            transition: all 0.2s; 
            background: #f8fafc;
        }
        .option-label:hover { 
            background: #eff6ff; 
            border-color: #3b82f6; 
        }
        /* Khi được chọn thì đổi màu */
        .option-input:checked + span {
            font-weight: bold;
            color: #2563eb;
        }
        .option-label:has(.option-input:checked) {
            border-color: #2563eb;
            background-color: #eff6ff;
        }

        .option-input { 
            margin-right: 15px; 
            transform: scale(1.2); 
            cursor: pointer;
        }
        
        .timer-box { position: fixed; top: 20px; right: 20px; background: #1e293b; color: white; padding: 10px 20px; border-radius: 30px; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 100; }
        .btn-submit { width: 100%; padding: 15px; background: #2563eb; color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 20px; box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3); transition: 0.2s;}
        .btn-submit:hover { background: #1d4ed8; transform: translateY(-2px); }
    </style>
</head>
<body>

    <div class="timer-box">⏳ <span id="timer">--:--</span></div>

    <main class="main-content">
        <div class="quiz-container">
            <a href="index.html" style="text-decoration: none; color: #64748b; display: inline-block; margin-bottom: 20px;">← Quay lại danh sách</a>
            <h1 id="quizTitle" style="margin: 0 0 30px 0; font-size: 2rem;">Đang tải đề thi...</h1>
            
            <form id="quizForm">
                <div id="questionsArea">
                    <p style="text-align: center; color: #64748b;">⏳ Đang tải câu hỏi...</p>
                </div>
                <button type="submit" class="btn-submit">Nộp bài</button>
            </form>
        </div>
    </main>

    <script>
const params = new URLSearchParams(window.location.search);
const quizId = params.get("id");
let questionsList = [];

if (!quizId) {
    alert("Không tìm thấy ID bài thi");
    location.href = "index.html";
}

function escapeHtml(text = "") {
    return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

async function loadQuiz() {
    try {
        const res = await fetch(`http://localhost:3000/api/quizzes/${quizId}`);
        if (!res.ok) throw new Error("API lỗi");

        const data = await res.json();
        console.log("QUIZ DATA:", data);

        const quiz = data.quiz;
        const questions = data.questions || [];

        document.getElementById("quizTitle").innerText = quiz.title;
        questionsList = questions;

        const area = document.getElementById("questionsArea");
        area.innerHTML = "";

        if (questions.length === 0) {
            area.innerHTML = "<p>❌ Đề thi chưa có câu hỏi.</p>";
            return;
        }

        questions.forEach((q, index) => {
            const qid = q.question_id || q.id;

            area.innerHTML += `
                <div class="question-card">
                    <div class="question-text">
                        Câu ${index + 1}: ${escapeHtml(q.question_text)}
                    </div>

                    ${["A","B","C","D"].map(opt => `
                        <label class="option-label">
                            <input type="radio" name="${qid}" value="${opt}" class="option-input">
                            <span>${opt}. ${escapeHtml(q["option_" + opt.toLowerCase()])}</span>
                        </label>
                    `).join("")}
                </div>
            `;
        });

        startTimer((quiz.duration_minutes || 15) * 60);

    } catch (err) {
        console.error(err);
        document.getElementById("quizTitle").innerText = "❌ Lỗi tải đề thi";
        document.getElementById("questionsArea").innerHTML =
            "<p>Không thể tải câu hỏi. Kiểm tra API.</p>";
    }
}

document.getElementById("quizForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    if (!confirm("Nộp bài?")) return;

    const answers = {};
    questionsList.forEach(q => {
        const qid = q.question_id || q.id;
        const checked = document.querySelector(`input[name="${qid}"]:checked`);
        if (checked) answers[qid] = checked.value;
    });

    const user = JSON.parse(localStorage.getItem("user_info")) || { user_id: 2 };

    const res = await fetch(`http://localhost:3000/api/quizzes/${quizId}/submit`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            user_id: user.user_id,
            answers
        })
    });

    const result = await res.json();
    alert(`Điểm: ${result.score}/10\nĐúng: ${result.correct}/${result.total}`);
    location.href = "index.html";
});

function startTimer(duration) {
    let timer = duration;
    const display = document.getElementById("timer");

    const interval = setInterval(() => {
        const m = String(Math.floor(timer / 60)).padStart(2, "0");
        const s = String(timer % 60).padStart(2, "0");
        display.textContent = `${m}:${s}`;

        if (--timer < 0) {
            clearInterval(interval);
            alert("⏰ Hết giờ!");
            document.getElementById("quizForm").requestSubmit();
        }
    }, 1000);
}

loadQuiz();
</script>

</body>
</html>
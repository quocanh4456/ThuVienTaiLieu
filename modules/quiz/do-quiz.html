<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>L√†m b√†i thi - EduPlatform</title>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <style>
        .quiz-container { max-width: 800px; margin: 0 auto; }
        .question-card { background: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .question-text { font-weight: bold; font-size: 1.1rem; margin-bottom: 20px; color: #1e293b; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; }
        
        /* Style cho ƒë√°p √°n ƒë·∫πp h∆°n */
        .option-label { 
            display: flex; 
            align-items: center; 
            padding: 12px 15px; 
            border: 2px solid #e2e8f0; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            cursor: pointer; 
            transition: all 0.2s; 
            background: #f8fafc;
        }
        .option-label:hover { 
            background: #eff6ff; 
            border-color: #3b82f6; 
        }
        /* Khi ƒë∆∞·ª£c ch·ªçn th√¨ ƒë·ªïi m√†u */
        .option-input:checked + span {
            font-weight: bold;
            color: #2563eb;
        }
        .option-label:has(.option-input:checked) {
            border-color: #2563eb;
            background-color: #eff6ff;
        }

        .option-input { 
            margin-right: 15px; 
            transform: scale(1.2); 
            cursor: pointer;
        }
        
        .timer-box { position: fixed; top: 20px; right: 20px; background: #1e293b; color: white; padding: 10px 20px; border-radius: 30px; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 100; }
        .btn-submit { width: 100%; padding: 15px; background: #2563eb; color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 20px; box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3); transition: 0.2s;}
        .btn-submit:hover { background: #1d4ed8; transform: translateY(-2px); }
    </style>
</head>
<body>

    <div class="timer-box">‚è≥ <span id="timer">--:--</span></div>

    <main class="main-content">
        <div class="quiz-container">
            <a href="index.html" style="text-decoration: none; color: #64748b; display: inline-block; margin-bottom: 20px;">‚Üê Quay l·∫°i danh s√°ch</a>
            <h1 id="quizTitle" style="margin: 0 0 30px 0; font-size: 2rem;">ƒêang t·∫£i ƒë·ªÅ thi...</h1>
            
            <form id="quizForm">
                <div id="questionsArea">
                    <p style="text-align: center; color: #64748b;">‚è≥ ƒêang t·∫£i c√¢u h·ªèi...</p>
                </div>
                <button type="submit" class="btn-submit">N·ªôp b√†i</button>
            </form>
        </div>
    </main>

    <script>
        const params = new URLSearchParams(window.location.search);
        const quizId = params.get('id');
        let questionsList = []; 

        if(!quizId) {
            alert("Kh√¥ng t√¨m th·∫•y b√†i thi!");
            window.location.href = 'index.html';
        }

        // --- H√ÄM QUAN TR·ªåNG: S·ª¨A L·ªñI HI·ªÇN TH·ªä TH·∫∫ HTML ---
        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        async function loadQuiz() {
            try {
                const res = await fetch(`http://localhost:3000/api/quizzes/${quizId}`);
                if(!res.ok) throw new Error("L·ªói k·∫øt n·ªëi");
                
                const data = await res.json();

                document.getElementById('quizTitle').innerText = data.quiz.title;
                questionsList = data.questions;

                const area = document.getElementById('questionsArea');
                area.innerHTML = '';
                
                if(data.questions.length === 0) {
                    area.innerHTML = '<p>ƒê·ªÅ thi n√†y ch∆∞a c√≥ c√¢u h·ªèi n√†o.</p>';
                    return;
                }

                data.questions.forEach((q, index) => {
                    // D√πng h√†m escapeHtml bao quanh c√°c ƒë√°p √°n
                    const html = `
                        <div class="question-card">
                            <div class="question-text">C√¢u ${index + 1}: ${escapeHtml(q.question_text)}</div>
                            
                            <label class="option-label">
                                <input type="radio" name="${q.question_id}" value="A" class="option-input">
                                <span>A. ${escapeHtml(q.option_a)}</span>
                            </label>
                            <label class="option-label">
                                <input type="radio" name="${q.question_id}" value="B" class="option-input">
                                <span>B. ${escapeHtml(q.option_b)}</span>
                            </label>
                            <label class="option-label">
                                <input type="radio" name="${q.question_id}" value="C" class="option-input">
                                <span>C. ${escapeHtml(q.option_c)}</span>
                            </label>
                            <label class="option-label">
                                <input type="radio" name="${q.question_id}" value="D" class="option-input">
                                <span>D. ${escapeHtml(q.option_d)}</span>
                            </label>
                        </div>
                    `;
                    area.innerHTML += html;
                });

                startTimer(data.quiz.time_limit * 60);

            } catch (error) {
                console.error(error);
                document.getElementById('quizTitle').innerText = "L·ªói t·∫£i ƒë·ªÅ thi!";
            }
        }

        // X·ª≠ l√Ω N·ªôp b√†i
        document.getElementById('quizForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if(!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i kh√¥ng?")) return;

            const answers = {};
            questionsList.forEach(q => {
                const selected = document.querySelector(`input[name="${q.question_id}"]:checked`);
                if (selected) {
                    answers[q.question_id] = selected.value;
                }
            });

            const btn = document.querySelector('.btn-submit');
            btn.innerText = "ƒêang ch·∫•m ƒëi·ªÉm...";
            btn.disabled = true;

            try {
                // L·∫•y th√¥ng tin user t·ª´ LocalStorage (n·∫øu c√≥)
                const userStr = localStorage.getItem('user_info');
                const user = userStr ? JSON.parse(userStr) : { user_id: 2 }; // M·∫∑c ƒë·ªãnh ID 2 n·∫øu ch∆∞a login

                const res = await fetch(`http://localhost:3000/api/quizzes/${quizId}/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user_id: user.user_id,
                        answers: answers 
                    })
                });
                
                const result = await res.json();
                
                alert(`üéâ K·∫æT QU·∫¢:\n\nƒêi·ªÉm s·ªë: ${result.score}/10\nS·ªë c√¢u ƒë√∫ng: ${result.correct}/${result.total}`);
                window.location.href = 'index.html';

            } catch (error) {
                alert("L·ªói khi n·ªôp b√†i: " + error.message);
                btn.innerText = "N·ªôp b√†i";
                btn.disabled = false;
            }
        });

        function startTimer(duration) {
            let timer = duration, minutes, seconds;
            const display = document.getElementById('timer');
            
            const interval = setInterval(function () {
                minutes = parseInt(timer / 60, 10);
                seconds = parseInt(timer % 60, 10);

                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;

                display.textContent = minutes + ":" + seconds;

                if (--timer < 0) {
                    clearInterval(interval);
                    alert("H·∫øt gi·ªù! H·ªá th·ªëng s·∫Ω t·ª± n·ªôp b√†i.");
                    // document.getElementById('quizForm').requestSubmit(); // T·ª± ƒë·ªông n·ªôp
                }
            }, 1000);
        }

        loadQuiz();
    </script>
</body>
</html>
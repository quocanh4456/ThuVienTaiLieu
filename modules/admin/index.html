<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - EduPlatform</title>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* GI·ªÆ NGUY√äN CSS C≈® */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #e2e8f0; }
        th { background-color: #f8fafc; color: #64748b; font-weight: 600; }
        .btn-action { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; }
        .btn-warning { background-color: var(--accent-color); color: white; }
        .btn-view { background-color: #e2e8f0; color: var(--text-dark); margin-right: 5px; }
        .tag { padding: 4px 8px; border-radius: 12px; color: white; font-size: 0.75rem; display: inline-block; }
        .tag-danger { background-color: #ef4444; }
        .tag-warning { background-color: #f59e0b; }

        /* --- CSS M·ªöI CHO MODAL (H·ªòP THO·∫†I CHI TI·∫æT) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); /* N·ªÅn t·ªëi m·ªù */
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
            justify-content: center; align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 12px;
            width: 500px; max-width: 90%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .modal-close { cursor: pointer; font-size: 1.5rem; color: #94a3b8; }
        .modal-close:hover { color: #ef4444; }
        
        /* B·∫£ng nh·ªè trong Modal */
        .detail-table th { background: #eff6ff; color: #1e3a8a; }
        .detail-table td { font-size: 0.9rem; }
        /* --- SIDEBAR STYLE CHU·∫®N (GI·ªêNG ·∫¢NH 1) --- */
        .sidebar {
            width: 260px !important;
            background-color: #111827 !important; /* N·ªÅn ƒëen xanh ƒë·∫≠m */
            display: flex !important;
            flex-direction: column !important;
            padding: 25px 20px !important;
            height: 100vh !important;
            flex-shrink: 0 !important;
            box-sizing: border-box !important;
            position: sticky !important;
            top: 0;
        }

        /* Logo EDUPLATFORM m√†u xanh ƒë·∫≠m */
        .logo {
            font-size: 1.6rem !important;
            font-weight: 900 !important;
            color: #3b82f6 !important; /* M√†u xanh th∆∞∆°ng hi·ªáu */
            text-transform: uppercase;
            margin-bottom: 40px !important;
            padding-left: 10px !important;
            letter-spacing: 1px !important;
            display: flex !important;
            align-items: center !important;
        }

        .nav-links {
            list-style: none !important;
            padding: 0 !important;
            margin: 0 !important;
            flex-grow: 1 !important; /* ƒê·∫©y n√∫t ƒëƒÉng xu·∫•t xu·ªëng ƒë√°y */
        }

        .nav-links li {
            margin-bottom: 10px !important;
        }

        /* Style chung cho Link v√† N√∫t */
        .nav-links a, .logout-btn {
            text-decoration: none !important;
            color: #9ca3af !important; /* M√†u x√°m nh·∫°t */
            display: flex !important;
            align-items: center !important; /* CƒÉn gi·ªØa icon v√† ch·ªØ */
            padding: 14px 16px !important;
            border-radius: 12px !important;
            transition: all 0.2s ease !important;
            font-weight: 500 !important;
            font-size: 0.95rem !important;
            cursor: pointer !important;
        }

        /* Icon: C·ªë ƒë·ªãnh ƒë·ªô r·ªông ƒë·ªÉ ch·ªØ th·∫≥ng h√†ng */
        .nav-icon {
            width: 30px !important;
            display: flex !important;
            justify-content: center !important; /* Icon n·∫±m gi·ªØa √¥ c·ªßa n√≥ */
            margin-right: 10px !important;
            font-size: 1.1rem !important;
        }

        /* Hi·ªáu ·ª©ng Hover */
        .nav-links a:hover, .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.05) !important;
            color: white !important;
        }

        /* --- TR·∫†NG TH√ÅI ACTIVE (N√öT ADMIN M√ÄU XANH) --- */
        .nav-links a.active {
            background-color: #3b82f6 !important; /* N·ªÅn xanh s√°ng */
            color: white !important;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4) !important; /* ƒê·ªï b√≥ng */
            font-weight: 600 !important;
        }

        /* Khi active, icon ƒë·ªïi m√†u tr·∫Øng */
        .nav-links a.active i {
            color: white !important;
        }

        /* N√∫t ƒêƒÉng xu·∫•t (M√†u ƒë·ªè, n·∫±m ƒë√°y) */
        .logout-btn {
            margin-top: auto !important;
            color: #ef4444 !important;
            font-weight: 600 !important;
        }
        .logout-btn:hover {
            background-color: rgba(239, 68, 68, 0.1) !important;
        }
    </style>
</head>
<body>
    <nav class="sidebar">
        <div class="logo">EDUPLATFORM</div>

        <ul class="nav-links">
            <li>
                <a href="../dashboard/index.html">
                    <span class="nav-icon"><i class="fa-solid fa-chart-pie"></i></span>
                    T·ªïng quan
                </a>
            </li>
            <li>
                <a href="../materials/index.html">
                    <span class="nav-icon"><i class="fa-solid fa-layer-group"></i></span>
                    Th∆∞ vi·ªán
                </a>
            </li>
            <li>
                <a href="../quiz/index.html">
                    <span class="nav-icon"><i class="fa-solid fa-pen-to-square"></i></span>
                    B√†i h·ªçc & Quiz
                </a>
            </li>
            <li>
                <a href="index.html" class="active">
                    <span class="nav-icon"><i class="fa-solid fa-gear"></i></span>
                    Admin
                </a>
            </li>
        </ul>

        <a onclick="logout()" class="logout-btn">
            <span class="nav-icon"><i class="fa-solid fa-right-from-bracket"></i></span>
            ƒêƒÉng xu·∫•t
        </a>
    </nav>  

    <main class="main-content">
        <header class="header">
            <h1>Trung t√¢m Qu·∫£n tr·ªã & C·∫£nh b√°o</h1>
            <div class="avatar">AD</div>
        </header>

        <div style="grid-column: 1 / -1; display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">
            <div class="card">
                <h3>Sinh vi√™n At-risk</h3>
                <p id="riskCount" style="font-size: 2rem; color: var(--danger-color); font-weight: bold;">0</p>
                <p style="font-size: 0.8rem; color: #64748b;">ƒêi·ªÉm trung b√¨nh < 5.0</p>
            </div>
            <div class="card">
                <h3>C·∫£nh b√°o ƒë√£ g·ª≠i (n8n)</h3>
                <p id="n8nCount" style="font-size: 2rem; color: var(--accent-color); font-weight: bold;">0</p>
            </div>
            <div class="card">
                <h3>T·ªïng h·ªçc vi√™n</h3>
                <p id="totalUsers" style="font-size: 2rem; color: var(--primary-color); font-weight: bold;">0</p>
            </div>
        </div>

        <div style="grid-column: 1 / -1;">
            <div class="card">
                <h3>üö® Danh s√°ch sinh vi√™n c·∫ßn can thi·ªáp</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Sinh vi√™n</th> <th>M√£ SV</th> <th>ƒêi·ªÉm TB</th> <th>T√¨nh tr·∫°ng</th> <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="riskTableBody">
                        <tr><td colspan="5" style="text-align: center;">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="detailModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Chi ti·∫øt ƒëi·ªÉm s·ªë</h3>
                <span class="modal-close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody">
                ƒêang t·∫£i.....
            </div>
        </div>
    </div>

    <script>
        function sendAlert(name) {
            const btn = event.currentTarget;
            btn.innerHTML = '...'; btn.disabled = true;
            setTimeout(() => {
                alert(`‚úÖ ƒê√£ g·ª≠i n8n nh·∫Øc nh·ªü t·ªõi: ${name}`);
                btn.innerHTML = 'ƒê√£ g·ª≠i';
                btn.style.background = '#dcfce7'; btn.style.color = '#166534';
            }, 800);
        }

        // --- H√ÄM X·ª¨ L√ù MODAL ---
        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        // H√†m xem chi ti·∫øt (G·ªçi API m·ªõi)
        async function viewDetails(userId, name) {
            // 1. Hi·ªán modal l√™n tr∆∞·ªõc
            const modal = document.getElementById('detailModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            
            modal.style.display = 'flex';
            title.innerText = `L·ªãch s·ª≠ thi: ${name}`;
            body.innerHTML = '<p style="text-align:center;">‚è≥ ƒêang l·∫•y d·ªØ li·ªáu...</p>';

            try {
                // 2. G·ªçi API l·∫•y ƒëi·ªÉm chi ti·∫øt
                const res = await fetch(`http://localhost:3000/api/admin/student-details/${userId}`);
                const details = await res.json();

                // 3. V·∫Ω b·∫£ng chi ti·∫øt
                if (details.length === 0) {
                    body.innerHTML = '<p style="color:red;">Sinh vi√™n n√†y ch∆∞a l√†m b√†i n√†o (L·ªói d·ªØ li·ªáu).</p>';
                    return;
                }

                let html = `
                    <table class="detail-table" style="margin-top:0;">
                        <thead>
                            <tr><th>B√†i thi</th> <th>ƒêi·ªÉm</th> <th>Ng√†y thi</th></tr>
                        </thead>
                        <tbody>
                `;

                details.forEach(d => {
                    // T√¥ m√†u ƒëi·ªÉm s·ªë
                    let scoreColor = '#166534'; // Xanh
                    if(d.score < 5) scoreColor = '#dc2626'; // ƒê·ªè
                    else if(d.score < 7) scoreColor = '#ca8a04'; // V√†ng

                    // Format ng√†y
                    const date = new Date(d.completed_at).toLocaleDateString('vi-VN');

                    html += `
                        <tr>
                            <td>${d.title}</td>
                            <td style="font-weight:bold; color:${scoreColor}">${d.score}</td>
                            <td>${date}</td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                body.innerHTML = html;

            } catch (error) {
                console.error(error);
                body.innerHTML = '<p style="color:red;">L·ªói k·∫øt n·ªëi Server!</p>';
            }
        }

        // --- H√ÄM LOAD D·ªÆ LI·ªÜU CH√çNH ---
        async function loadAdminData() {
            try {
                const res = await fetch('http://localhost:3000/api/admin/dashboard');
                const data = await res.json();

                document.getElementById('totalUsers').innerText = data.total_students || 0;
                document.getElementById('riskCount').innerText = data.at_risk_count || 0;
                document.getElementById('n8nCount').innerText = data.n8n_sent || 0;

                const tableBody = document.getElementById('riskTableBody');
                tableBody.innerHTML = '';

                if (data.risk_list.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Tuy·ªát v·ªùi! Kh√¥ng c√≥ ai d∆∞·ªõi trung b√¨nh.</td></tr>';
                    return;
                }

                data.risk_list.forEach(student => {
                    const avg = parseFloat(student.avg_score).toFixed(1);
                    let statusHtml = avg < 5.0 
                        ? '<span class="tag tag-danger">Nguy c∆° cao</span>' 
                        : '<span class="tag tag-warning">C·∫ßn ch√∫ √Ω</span>';
                    
                    const studentId = student.user_id ? `SV${String(student.user_id).padStart(3, '0')}` : '---';

                    const row = `
                        <tr>
                            <td>${student.full_name}</td>
                            <td>${studentId}</td>
                            <td style="font-weight: bold;">${avg}</td>
                            <td>${statusHtml}</td>
                            <td>
                                <button class="btn-action btn-view" onclick="viewDetails(${student.user_id}, '${student.full_name}')">
                                    Chi ti·∫øt
                                </button>
                                <button class="btn-action btn-warning" onclick="sendAlert('${student.full_name}')">
                                    G·ª≠i n8n
                                </button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });

            } catch (error) { console.error(error); }
        }

        loadAdminData();
    </script>
</body>
</html>
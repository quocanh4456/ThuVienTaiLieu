<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Chi ti·∫øt t√†i li·ªáu - EduPlatform</title>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <style>
        .preview-box {
            height: 650px;
            background: #e2e8f0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid #cbd5e1;
            position: relative;
        }
        .preview-content { width: 100%; height: 100%; border: none; }
    </style>
</head>
<script>
 window.difyChatbotConfig = {
  token: '5kyb3HqpAOqpvEtf',
  inputs: {
    // You can define the inputs from the Start node here
    // key is the variable name
    // e.g.
    // name: "NAME"
  },
  systemVariables: {
    // user_id: 'YOU CAN DEFINE USER ID HERE',
    // conversation_id: 'YOU CAN DEFINE CONVERSATION ID HERE, IT MUST BE A VALID UUID',
  },
  userVariables: {
    // avatar_url: 'YOU CAN DEFINE USER AVATAR URL HERE',
    // name: 'YOU CAN DEFINE USER NAME HERE',
  },
 }
</script>
<script
 src="https://udify.app/embed.min.js"
 id="5kyb3HqpAOqpvEtf"
 defer>
</script>
<style>
  #dify-chatbot-bubble-button {
    background-color: #1C64F2 !important;
  }
  #dify-chatbot-bubble-window {
    width: 24rem !important;
    height: 40rem !important;
  }
</style>
<body>
    <nav class="sidebar">
        <div class="logo">EduPlatform</div>
        <ul class="nav-links">
            <li><a href="index.html">‚Üê Quay l·∫°i th∆∞ vi·ªán</a></li>
            <hr style="border: 0; border-top: 1px solid #334155; margin: 10px 0;">
            <li><a href="../dashboard/index.html"><span class="nav-icon">üìä</span> Dashboard</a></li>
        </ul>
    </nav>

    <main class="main-content">
        <header class="header">
            <h1 id="docTitle">ƒêang t·∫£i d·ªØ li·ªáu...</h1>
            <div class="avatar">A</div>
        </header>

        <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 30px;">
            <div>
                <div class="card" style="padding: 0; overflow: hidden;">
                    <div class="preview-box" id="previewContainer">
                        <p style="color: #64748b;">‚è≥ ƒêang t·∫£i b·∫£n xem tr∆∞·ªõc...</p>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h3>üí¨ B√¨nh lu·∫≠n</h3>
                    <div id="reviewsList" style="margin-top: 15px;">
                        <p style="color: #64748b;">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</p>
                    </div>
                </div>
            </div>

            <aside>
                <div class="card">
                    <a id="downloadBtn" href="#" target="_blank" style="text-decoration: none;">
                        <button style="width: 100%; padding: 15px; background: var(--success-color); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-bottom: 15px;">
                            ‚¨á T·∫£i xu·ªëng
                        </button>
                    </a>
                    
                    <div style="font-size: 0.9rem; line-height: 1.8;">
                        <p><strong>Ch·ªß ƒë·ªÅ:</strong> <span id="docTopic">...</span></p>
                        <p><strong>Lo·∫°i file:</strong> <span id="docType">...</span></p>
                        <p><strong>L∆∞·ª£t t·∫£i:</strong> <span id="docDownloads">0</span></p>
                        <hr style="margin: 10px 0;">
                        <p><strong>M√¥ t·∫£:</strong> <span id="docDesc">...</span></p>
                    </div>
                </div>
            </aside>
        </div>
    </main>
    
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const docId = urlParams.get('id');

        async function loadDetail() {
            if (!docId) return alert("Kh√¥ng t√¨m th·∫•y ID!");

            try {
                const response = await fetch(`http://localhost:3000/api/materials/${docId}`);
                if (!response.ok) throw new Error("L·ªói k·∫øt n·ªëi");

                const data = await response.json();
                const mat = data.material;
                
                // 1. ƒêi·ªÅn th√¥ng tin
                document.getElementById('docTitle').innerText = mat.title;
                document.getElementById('docTopic').innerText = mat.topic;
                document.getElementById('docType').innerText = mat.type;
                document.getElementById('docDownloads').innerText = mat.downloads;
                document.getElementById('docDesc').innerText = mat.description || "Kh√¥ng c√≥ m√¥ t·∫£.";

                // 2. X·ª≠ l√Ω URL (Chu·∫©n h√≥a ƒë∆∞·ªùng d·∫´n)
                let rawPath = mat.file_url ? mat.file_url.replace(/\\/g, '/') : '';
                if(rawPath && !rawPath.startsWith('http')) {
                    rawPath = `http://localhost:3000/${rawPath}`;
                }
                const fileUrl = rawPath;

                // N√∫t Download
                document.getElementById('downloadBtn').href = fileUrl;

                // 3. Logic hi·ªÉn th·ªã Preview (Th√¥ng minh)
                const previewDiv = document.getElementById('previewContainer');
                const fileExt = fileUrl.split('.').pop().toLowerCase(); // L·∫•y ƒëu√¥i file (pdf, pptx, docx)

                if (fileUrl && (fileExt === 'pdf' || mat.type === 'PDF')) {
                    // PDF -> Hi·ªÉn th·ªã
                    previewDiv.innerHTML = `
                        <object data="${fileUrl}" type="application/pdf" class="preview-content">
                            <div style="text-align:center; padding-top: 150px;">
                                <p>‚ö†Ô∏è Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ xem tr·ª±c ti·∫øp.</p>
                                <a href="${fileUrl}" target="_blank">B·∫•m ƒë·ªÉ t·∫£i v·ªÅ</a>
                            </div>
                        </object>`;
                } else if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExt)) {
                    // ·∫¢nh -> Hi·ªÉn th·ªã
                    previewDiv.innerHTML = `<img src="${fileUrl}" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
                } else if (['doc', 'docx', 'ppt', 'pptx', 'xls', 'xlsx'].includes(fileExt) || mat.type === 'DOCX' || mat.type === 'PPTX') {
                    // File Office (Word, PPT) -> Hi·ªán th√¥ng b√°o
                    previewDiv.innerHTML = `
                        <div style="text-align:center">
                            <span style="font-size: 4rem;">üìÇ</span>
                            <h3 style="margin-top: 10px; color: #334155;">T√†i li·ªáu Office</h3>
                            <p style="color: #64748b;">Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ xem tr∆∞·ªõc ƒë·ªãnh d·∫°ng n√†y.</p>
                            <a href="${fileUrl}" style="display: inline-block; margin-top: 15px; padding: 10px 20px; background: var(--primary-color); color: white; text-decoration: none; border-radius: 6px;">
                                ‚¨á T·∫£i v·ªÅ m√°y ƒë·ªÉ xem
                            </a>
                        </div>`;
                } else if (mat.type === 'VIDEO' || ['mp4'].includes(fileExt)) {
                    previewDiv.innerHTML = `<video controls class="preview-content" style="background: black;"><source src="${fileUrl}" type="video/mp4"></video>`;
                } else {
                    // C√°c lo·∫°i kh√°c
                    previewDiv.innerHTML = `<div style="text-align:center"><p>Kh√¥ng h·ªó tr·ª£ xem tr∆∞·ªõc.</p><a href="${fileUrl}">T·∫£i v·ªÅ</a></div>`;
                }
                
                // (Ph·∫ßn hi·ªÉn th·ªã b√¨nh lu·∫≠n gi·ªØ nguy√™n nh∆∞ c≈©...)
                
            } catch (error) {
                console.error(error);
                document.getElementById('docTitle').innerText = "L·ªói t·∫£i t√†i li·ªáu.";
            }
        }
        window.onload = loadDetail;
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="vi">
<head>
    <!-- Khai b√°o b·ªô m√£ UTF-8 ƒë·ªÉ hi·ªÉn th·ªã ti·∫øng Vi·ªát ƒë√∫ng -->
    <meta charset="UTF-8">

    <!-- Ti√™u ƒë·ªÅ hi·ªÉn th·ªã tr√™n tab tr√¨nh duy·ªát -->
    <title>Chi ti·∫øt t√†i li·ªáu - EduPlatform</title>

    <!-- Import CSS chung c·ªßa d·ª± √°n (layout sidebar, main-content, tag, v.v.) -->
    <link rel="stylesheet" href="../../assets/css/style.css">

    <style>
        /* 
          preview-box:
          - Khung hi·ªÉn th·ªã "xem tr∆∞·ªõc" t√†i li·ªáu (PDF iframe / ·∫£nh / video)
          - height 600px gi√∫p n·ªôi dung xem tr∆∞·ªõc ƒë·ªß l·ªõn
          - display flex + center ƒë·ªÉ khi ƒëang loading ho·∫∑c kh√¥ng h·ªó tr·ª£ preview th√¨ n·ªôi dung n·∫±m gi·ªØa
        */
        .preview-box {
            width: 100%;
            height: 600px;
            background: #f1f5f9;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e2e8f0;
            margin-top: 20px;
        }

        /*
          info-box:
          - H·ªôp th√¥ng tin b√™n ph·∫£i (download + topic + type + date + description)
          - shadow nh·∫π ƒë·ªÉ n·ªïi b·∫≠t
          - height: fit-content ƒë·ªÉ h·ªôp ch·ªâ cao v·ª´a ƒë·ªß theo n·ªôi dung
        */
        .info-box {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            height: fit-content;
        }

        /*
          btn-download:
          - Th·∫ª <a> ƒë∆∞·ª£c style nh∆∞ m·ªôt n√∫t b·∫•m
          - width 100% ƒë·ªÉ chi·∫øm to√†n b·ªô chi·ªÅu ngang info-box
          - cursor pointer ƒë·ªÉ gi·ªëng button
        */
        .btn-download {
            display: block;
            width: 100%;
            padding: 12px;
            background: var(--success-color);
            color: white;
            text-align: center;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            margin-bottom: 20px;
            cursor: pointer;
            border: none;
        }

        /* Hover l√†m m·ªù nh·∫π ƒë·ªÉ t·∫°o feedback */
        .btn-download:hover { opacity: 0.9; }
    </style>
</head>

<body>
    <!-- Sidebar ƒëi·ªÅu h∆∞·ªõng (n·∫±m b√™n tr√°i) -->
    <nav class="sidebar">
        <!-- Logo/Brand -->
        <div class="logo">EduPlatform</div>

        <!-- Danh s√°ch link ƒëi·ªÅu h∆∞·ªõng -->
        <ul class="nav-links">
            <!-- Link sang trang Dashboard -->
            <li>
                <a href="../dashboard/index.html">
                    <span class="nav-icon">üìä</span> T·ªïng quan
                </a>
            </li>

            <!-- Link sang trang Th∆∞ vi·ªán (ƒëang active) -->
            <li>
                <a href="index.html" class="active">
                    <span class="nav-icon">üìö</span> Th∆∞ vi·ªán
                </a>
            </li>

            <!-- Link sang trang Quiz -->
            <li>
                <a href="../quiz/index.html">
                    <span class="nav-icon">üìù</span> B√†i h·ªçc & Quiz
                </a>
            </li>
        </ul>
    </nav>

    <!-- Main content: chia 2 c·ªôt (tr√°i preview, ph·∫£i info) -->
    <main class="main-content" style="grid-template-columns: 2fr 1fr;">
        <!-- C·ªôt tr√°i: Back + Title + Preview -->
        <div>
            <!-- Link quay l·∫°i trang th∆∞ vi·ªán -->
            <a href="index.html" style="color: #64748b; text-decoration: none;">‚Üê Quay l·∫°i th∆∞ vi·ªán</a>

            <!-- Ti√™u ƒë·ªÅ t√†i li·ªáu: l√∫c ƒë·∫ßu l√† loading, sau ƒë√≥ JS s·∫Ω set b·∫±ng m.title -->
            <h1 id="docTitle" style="margin-top: 15px;">ƒêang t·∫£i d·ªØ li·ªáu...</h1>

            <!-- Khung preview: l√∫c ƒë·∫ßu hi·ªÉn th·ªã text loading, sau JS render iframe/img/video -->
            <div class="preview-box" id="previewArea">
                <p>ƒêang t·∫£i b·∫£n xem tr∆∞·ªõc...</p>
            </div>
        </div>

        <!-- C·ªôt ph·∫£i: Download + metadata -->
        <div class="info-box">
            <!-- N√∫t download:
                 - href ban ƒë·∫ßu l√† "#"
                 - JS s·∫Ω set href th√†nh ƒë∆∞·ªùng d·∫´n file th·ª±c t·∫ø
                 - target="_blank" ƒë·ªÉ m·ªü tab m·ªõi (tr√°nh m·∫•t trang hi·ªán t·∫°i)
            -->
            <a id="btnDownload" href="#" target="_blank" class="btn-download">‚¨á T·∫£i xu·ªëng ngay</a>

            <!-- Th√¥ng tin ch·ªß ƒë·ªÅ: JS set n·ªôi dung v√†o span#docTopic -->
            <p><strong>Ch·ªß ƒë·ªÅ:</strong> <span id="docTopic">...</span></p>

            <!-- Th√¥ng tin lo·∫°i file: JS set n·ªôi dung v√†o span#docType -->
            <!-- class="tag" ƒë·ªÉ d√πng style tag t·ª´ CSS chung -->
            <p><strong>Lo·∫°i file:</strong> <span class="tag" id="docType">...</span></p>

            <!-- Ng√†y ƒëƒÉng: JS set n·ªôi dung v√†o span#docDate -->
            <p><strong>Ng√†y ƒëƒÉng:</strong> <span id="docDate">...</span></p>

            <!-- Line ph√¢n c√°ch ph·∫ßn metadata v√† m√¥ t·∫£ -->
            <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">

            <p><strong>M√¥ t·∫£:</strong></p>

            <!-- M√¥ t·∫£: JS set n·ªôi dung v√†o p#docDesc -->
            <p id="docDesc" style="color: #64748b; font-size: 0.95rem; line-height: 1.5;">...</p>
        </div>
    </main>

    <script>
        /**
         * ==============================
         * 1) L·∫§Y ID T·ª™ QUERY STRING
         * ==============================
         * V√≠ d·ª• URL: detail.html?id=5
         * window.location.search = "?id=5"
         * URLSearchParams gi√∫p parse query string d·ªÖ d√†ng
         */
        const params = new URLSearchParams(window.location.search);

        // L·∫•y gi√° tr·ªã tham s·ªë "id"
        const id = params.get('id');

        /**
         * N·∫øu kh√¥ng c√≥ id => user truy c·∫≠p sai ƒë∆∞·ªùng d·∫´n
         * - alert ƒë·ªÉ b√°o l·ªói
         * - redirect v·ªÅ trang th∆∞ vi·ªán (index.html)
         */
        if (!id) {
            alert("Kh√¥ng t√¨m th·∫•y ID t√†i li·ªáu!");
            window.location.href = 'index.html';
        }

        /**
         * ==============================
         * 2) H√ÄM G·ªåI API L·∫§Y CHI TI·∫æT
         * ==============================
         * - G·ªçi GET /api/materials/:id
         * - Parse JSON
         * - Hi·ªÉn th·ªã th√¥ng tin v√† preview
         */
        async function loadDetail() {
            try {
                /**
                 * G·ªçi API backend l·∫•y detail material theo id
                 * NOTE: ƒëang hardcode "http://localhost:3000"
                 */
                const res = await fetch(`http://localhost:3000/api/materials/${id}`);

                /**
                 * Parse response JSON
                 * NOTE: n·∫øu server tr·∫£ v·ªÅ kh√¥ng ph·∫£i JSON ho·∫∑c l·ªói m·∫°ng -> s·∫Ω throw v√† nh·∫£y v√†o catch
                 */
                const data = await res.json();

                /**
                 * Backend hi·ªán t·∫°i tr·∫£ v·ªÅ m·∫£ng result (MySQL):
                 *   [ { material_id: ..., title: ..., ... } ]
                 * n√™n frontend l·∫•y ph·∫ßn t·ª≠ ƒë·∫ßu ti√™n
                 */
                const m = data[0];

                /**
                 * N·∫øu kh√¥ng c√≥ data (m undefined):
                 * - update title b√°o kh√¥ng t·ªìn t·∫°i
                 * - return ƒë·ªÉ d·ª´ng x·ª≠ l√Ω ti·∫øp
                 */
                if (!m) {
                    document.getElementById('docTitle').innerText = "T√†i li·ªáu kh√¥ng t·ªìn t·∫°i!";
                    return;
                }

                /**
                 * ==============================
                 * 3) HI·ªÇN TH·ªä TH√îNG TIN L√äN UI
                 * ==============================
                 * - innerText/textContent d√πng ƒë·ªÉ set text (an to√†n h∆°n innerHTML)
                 * - docType: hi·ªÉn th·ªã uppercase ƒë·ªÉ ƒë·∫πp
                 * - docDesc: fallback n·∫øu kh√¥ng c√≥ m√¥ t·∫£
                 * - docDate: format theo locale vi-VN
                 */
                document.getElementById('docTitle').innerText = m.title;
                document.getElementById('docTopic').innerText = m.topic;
                document.getElementById('docType').innerText = m.type ? m.type.toUpperCase() : 'FILE';
                document.getElementById('docDesc').innerText = m.description || "Kh√¥ng c√≥ m√¥ t·∫£.";
                document.getElementById('docDate').innerText = new Date(m.created_at).toLocaleDateString('vi-VN');

                /**
                 * ==============================
                 * 4) X·ª¨ L√ù ƒê∆Ø·ªúNG D·∫™N FILE
                 * ==============================
                 * m.link th∆∞·ªùng l∆∞u d·∫°ng t∆∞∆°ng ƒë·ªëi, v√≠ d·ª•: "uploads/xxx.pdf"
                 * - N·∫øu link ch∆∞a c√≥ "http" => th√™m base url backend v√†o tr∆∞·ªõc
                 * - Sau ƒë√≥ set cho n√∫t download
                 */
                let fileUrl = m.link;

                // N·∫øu link l√† path t∆∞∆°ng ƒë·ªëi th√¨ th√™m base URL
                if (fileUrl && !fileUrl.startsWith('http')) {
                    fileUrl = `http://localhost:3000/${fileUrl}`;
                }

                // G√°n href cho n√∫t t·∫£i xu·ªëng
                document.getElementById('btnDownload').href = fileUrl;

                /**
                 * ==============================
                 * 5) X·ª¨ L√ù PREVIEW (XEM TR∆Ø·ªöC)
                 * ==============================
                 * - D·ª±a tr√™n m.type (ƒë√£ l∆∞u trong DB) ƒë·ªÉ quy·∫øt ƒë·ªãnh render preview
                 * - pdf: iframe
                 * - image: img
                 * - video/mp4: video tag
                 * - kh√°c: th√¥ng b√°o kh√¥ng h·ªó tr·ª£
                 *
                 * NOTE: d√πng innerHTML ƒë·ªÉ render nhanh, nh∆∞ng n·∫øu mu·ªën an to√†n h∆°n c√≥ th·ªÉ t·∫°o element b·∫±ng createElement.
                 */
                const preview = document.getElementById('previewArea');

                // Normalize type v·ªÅ ch·ªØ th∆∞·ªùng ƒë·ªÉ so s√°nh
                const type = m.type ? m.type.toLowerCase() : '';

                // Preview PDF b·∫±ng iframe
                if (type === 'pdf') {
                    preview.innerHTML = `<iframe src="${fileUrl}" width="100%" height="100%" style="border:none;"></iframe>`;

                // Preview ·∫£nh (jpg/png/jpeg/gif)
                } else if (['jpg', 'png', 'jpeg', 'gif'].includes(type)) {
                    preview.innerHTML = `<img src="${fileUrl}" style="max-width:100%; max-height:100%; object-fit:contain;">`;

                // Preview video (type = 'video' ho·∫∑c 'mp4')
                } else if (type === 'video' || type === 'mp4') {
                    preview.innerHTML = `<video controls width="100%" height="100%"><source src="${fileUrl}" type="video/mp4"></video>`;

                // C√°c ƒë·ªãnh d·∫°ng kh√°c kh√¥ng h·ªó tr·ª£ xem tr∆∞·ªõc
                } else {
                    preview.innerHTML = `
                        <div style="text-align:center;">
                            <p style="font-size:3rem;">üìÇ</p>
                            <p>ƒê·ªãnh d·∫°ng <b>${type}</b> kh√¥ng h·ªó tr·ª£ xem tr∆∞·ªõc.</p>
                            <p>Vui l√≤ng b·∫•m n√∫t <b>T·∫£i xu·ªëng</b> ƒë·ªÉ xem.</p>
                        </div>
                    `;
                }

            } catch (error) {
                /**
                 * catch:
                 * - b·∫Øt l·ªói network (fetch fail)
                 * - l·ªói parse JSON
                 * - l·ªói runtime kh√°c
                 */
                console.error(error);
                alert("L·ªói t·∫£i d·ªØ li·ªáu: " + error.message);
            }
        }

        /**
         * G·ªçi loadDetail ngay khi script ch·∫°y (t·ª©c l√† khi trang ƒë∆∞·ª£c load)
         */
        loadDetail();
    </script>
</body>
</html>
